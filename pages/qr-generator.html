<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de QR Code - Sistema de Inventário</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/uuid@9.0.0/dist/umd/uuidv4.min.js"></script>
    <style>
        .areluna-gradient {
            background: linear-gradient(135deg, #1e40af 0%, #f59e0b 100%);
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .status-online { color: #10b981; }
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .btn-primary {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
        }
        .btn-secondary {
            background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
        }
        #qrcode-container {
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-900 via-blue-800 to-amber-600 min-h-screen">
    <!-- Header -->
    <header class="glass-effect text-white p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <i class="fas fa-qrcode text-2xl text-amber-400"></i>
                <h1 class="text-2xl font-bold">Gerador de QR Code</h1>
            </div>
            <div class="flex items-center space-x-4">
                <button onclick="window.location.href='inventory.html'" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg transition-colors">
                    <i class="fas fa-arrow-left mr-2"></i>Voltar
                </button>
                <button onclick="window.location.href='../index.html'" class="bg-amber-500 hover:bg-amber-600 px-4 py-2 rounded-lg transition-colors">
                    <i class="fas fa-home mr-2"></i>Portal
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto p-6">
        <div class="grid lg:grid-cols-2 gap-6">
            <!-- Formulário de Entrada -->
            <div class="card rounded-2xl p-6 shadow-xl">
                <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
                    <i class="fas fa-edit text-blue-600 mr-3"></i>
                    Dados do Item
                </h2>
                
                <form id="qr-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nome do Item *</label>
                        <input type="text" id="item-name" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="Ex: Notebook Dell Inspiron">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Código do Item</label>
                        <input type="text" id="item-code" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="Ex: NB-001 (deixe vazio para gerar automaticamente)">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Categoria</label>
                        <select id="item-category" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="Equipamento">Equipamento</option>
                            <option value="Mobiliário">Mobiliário</option>
                            <option value="Veículo">Veículo</option>
                            <option value="Eletrônico">Eletrônico</option>
                            <option value="Ferramenta">Ferramenta</option>
                            <option value="Outro">Outro</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Localização</label>
                        <input type="text" id="item-location" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="Ex: Sala 101, Andar 2">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                        <select id="item-status" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="active">Ativo</option>
                            <option value="maintenance">Manutenção</option>
                            <option value="inactive">Inativo</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Valor (R$)</label>
                        <input type="number" id="item-value" step="0.01" min="0"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="Ex: 2500.00">
                    </div>
                    
                    <div class="pt-4">
                        <button type="submit" class="w-full btn-primary text-white py-3 px-4 rounded-lg hover:opacity-90 transition-opacity font-semibold">
                            <i class="fas fa-qrcode mr-2"></i>
                            Gerar QR Code
                        </button>
                    </div>
                </form>
            </div>

            <!-- Preview e Download -->
            <div class="card rounded-2xl p-6 shadow-xl">
                <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
                    <i class="fas fa-eye text-green-600 mr-3"></i>
                    Preview do QR Code
                </h2>
                
                <!-- QR Code Display -->
                <div id="qrcode-container" class="bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg mb-6">
                    <div class="text-center text-gray-500">
                        <i class="fas fa-qrcode text-4xl mb-2"></i>
                        <p>Preencha os dados para gerar o QR Code</p>
                    </div>
                </div>
                
                <!-- Informações do Item -->
                <div id="item-info" class="bg-blue-50 rounded-lg p-4 mb-6 hidden">
                    <h3 class="font-semibold text-gray-800 mb-2">Informações do Item:</h3>
                    <div id="item-details" class="text-sm text-gray-600 space-y-1"></div>
                </div>
                
                <!-- Botões de Ação -->
                <div id="action-buttons" class="space-y-3 hidden">
                    <button onclick="downloadQRCode()" class="w-full btn-secondary text-white py-2 px-4 rounded-lg hover:opacity-90 transition-opacity">
                        <i class="fas fa-download mr-2"></i>
                        Baixar QR Code (PNG)
                    </button>
                    
                    <button onclick="printQRCode()" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg transition-colors">
                        <i class="fas fa-print mr-2"></i>
                        Imprimir Etiqueta
                    </button>
                    
                    <button onclick="generateNew()" class="w-full bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-lg transition-colors">
                        <i class="fas fa-plus mr-2"></i>
                        Gerar Novo QR Code
                    </button>
                </div>
            </div>
        </div>

        <!-- Instruções -->
        <div class="card rounded-2xl p-6 shadow-xl mt-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-info-circle text-blue-600 mr-3"></i>
                Como Usar
            </h2>
            <div class="grid md:grid-cols-3 gap-6 text-sm text-gray-600">
                <div class="text-center">
                    <div class="bg-blue-100 rounded-full w-12 h-12 flex items-center justify-center mx-auto mb-3">
                        <i class="fas fa-edit text-blue-600"></i>
                    </div>
                    <h3 class="font-semibold mb-2">1. Preencher Dados</h3>
                    <p>Insira as informações do item que receberá o QR Code</p>
                </div>
                <div class="text-center">
                    <div class="bg-green-100 rounded-full w-12 h-12 flex items-center justify-center mx-auto mb-3">
                        <i class="fas fa-qrcode text-green-600"></i>
                    </div>
                    <h3 class="font-semibold mb-2">2. Gerar QR Code</h3>
                    <p>Clique em "Gerar QR Code" para criar o código</p>
                </div>
                <div class="text-center">
                    <div class="bg-amber-100 rounded-full w-12 h-12 flex items-center justify-center mx-auto mb-3">
                        <i class="fas fa-download text-amber-600"></i>
                    </div>
                    <h3 class="font-semibold mb-2">3. Baixar/Imprimir</h3>
                    <p>Baixe o arquivo ou imprima a etiqueta diretamente</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="glass-effect text-white text-center p-4 mt-8">
        <p>&copy; 2024 Grupo AreLuna - Gerador de QR Code</p>
        <p class="text-sm opacity-80">Sistema de Inventário Patrimonial</p>
    </footer>

    <script>
        let currentQRData = null;
        let currentCanvas = null;

        // Gerar código automático
        function generateItemCode() {
            const prefix = document.getElementById('item-category').value.substring(0, 2).toUpperCase();
            const timestamp = Date.now().toString().slice(-6);
            return `${prefix}-${timestamp}`;
        }

        // Gerar dados estruturados para o QR Code
        function generateQRData() {
            const itemId = uuidv4();
            const itemCode = document.getElementById('item-code').value || generateItemCode();
            
            const qrData = {
                id: itemId,
                code: itemCode,
                name: document.getElementById('item-name').value,
                category: document.getElementById('item-category').value,
                location: document.getElementById('item-location').value,
                status: document.getElementById('item-status').value,
                value: parseFloat(document.getElementById('item-value').value) || 0,
                url: `${window.location.origin}/asset/${itemId}`,
                timestamp: new Date().toISOString()
            };
            
            return qrData;
        }

        // Gerar QR Code
        async function generateQRCode() {
            const qrData = generateQRData();
            currentQRData = qrData;
            
            // Limpar container
            const container = document.getElementById('qrcode-container');
            container.innerHTML = '';
            
            try {
                // Gerar QR Code usando a biblioteca QRCode.js
                const canvas = document.createElement('canvas');
                await QRCode.toCanvas(canvas, JSON.stringify(qrData), {
                    width: 300,
                    margin: 2,
                    color: {
                        dark: '#000000',
                        light: '#FFFFFF'
                    },
                    errorCorrectionLevel: 'M'
                });
                
                currentCanvas = canvas;
                container.appendChild(canvas);
                
                // Mostrar informações do item
                displayItemInfo(qrData);
                
                // Mostrar botões de ação
                document.getElementById('action-buttons').classList.remove('hidden');
                
                // Atualizar código no formulário se foi gerado automaticamente
                if (!document.getElementById('item-code').value) {
                    document.getElementById('item-code').value = qrData.code;
                }
                
            } catch (error) {
                console.error('Erro ao gerar QR Code:', error);
                container.innerHTML = `
                    <div class="text-center text-red-500">
                        <i class="fas fa-exclamation-triangle text-4xl mb-2"></i>
                        <p>Erro ao gerar QR Code</p>
                    </div>
                `;
            }
        }

        // Exibir informações do item
        function displayItemInfo(qrData) {
            const infoContainer = document.getElementById('item-info');
            const detailsContainer = document.getElementById('item-details');
            
            const statusText = {
                'active': 'Ativo',
                'maintenance': 'Manutenção',
                'inactive': 'Inativo'
            };
            
            detailsContainer.innerHTML = `
                <div><strong>ID:</strong> ${qrData.id.slice(0, 8)}...</div>
                <div><strong>Código:</strong> ${qrData.code}</div>
                <div><strong>Nome:</strong> ${qrData.name}</div>
                <div><strong>Categoria:</strong> ${qrData.category}</div>
                <div><strong>Localização:</strong> ${qrData.location || 'Não informado'}</div>
                <div><strong>Status:</strong> ${statusText[qrData.status]}</div>
                ${qrData.value > 0 ? `<div><strong>Valor:</strong> R$ ${qrData.value.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</div>` : ''}
                <div><strong>Gerado em:</strong> ${new Date(qrData.timestamp).toLocaleString('pt-BR')}</div>
            `;
            
            infoContainer.classList.remove('hidden');
        }

        // Baixar QR Code
        function downloadQRCode() {
            if (!currentCanvas) return;
            
            const link = document.createElement('a');
            link.download = `qr-${currentQRData.code}-${currentQRData.id.slice(0, 8)}.png`;
            link.href = currentCanvas.toDataURL('image/png');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Feedback visual
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-check mr-2"></i>Baixado!';
            button.classList.add('bg-green-600');
            
            setTimeout(() => {
                button.innerHTML = originalText;
                button.classList.remove('bg-green-600');
            }, 2000);
        }

        // Imprimir QR Code
        function printQRCode() {
            if (!currentCanvas || !currentQRData) return;
            
            const printWindow = window.open('', '_blank');
            const qrDataUrl = currentCanvas.toDataURL('image/png');
            
            const printHTML = `<!DOCTYPE html>
<html>
<head>
    <title>Etiqueta QR Code - ${currentQRData.code}</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            text-align: center;
        }
        .label {
            border: 2px solid #000;
            padding: 20px;
            display: inline-block;
            max-width: 400px;
        }
        .qr-code { margin: 10px 0; }
        .item-info { text-align: left; margin-top: 15px; }
        .item-info div { margin: 5px 0; }
        @media print {
            body { margin: 0; }
            .label { border: 1px solid #000; }
        }
    </style>
</head>
<body>
    <div class="label">
        <h2>${currentQRData.name}</h2>
        <div class="qr-code">
            <img src="${qrDataUrl}" alt="QR Code" style="max-width: 200px;">
        </div>
        <div class="item-info">
            <div><strong>Código:</strong> ${currentQRData.code}</div>
            <div><strong>Categoria:</strong> ${currentQRData.category}</div>
            ${currentQRData.location ? '<div><strong>Local:</strong> ' + currentQRData.location + '</div>' : ''}
            <div><strong>ID:</strong> ${currentQRData.id}</div>
        </div>
    </div>
    <script>
        window.onload = function() {
            window.print();
            window.onafterprint = function() {
                window.close();
            };
        };
    </script>
</body>
</html>`;
            
            printWindow.document.write(printHTML);
            printWindow.document.close();
        }

        // Gerar novo QR Code
        function generateNew() {
            document.getElementById('qr-form').reset();
            document.getElementById('qrcode-container').innerHTML = `
                <div class="text-center text-gray-500">
                    <i class="fas fa-qrcode text-4xl mb-2"></i>
                    <p>Preencha os dados para gerar o QR Code</p>
                </div>
            `;
            document.getElementById('item-info').classList.add('hidden');
            document.getElementById('action-buttons').classList.add('hidden');
            currentQRData = null;
            currentCanvas = null;
        }

        // Event listeners
        document.getElementById('qr-form').addEventListener('submit', function(e) {
            e.preventDefault();
            generateQRCode();
        });

        // Auto-gerar código quando categoria muda
        document.getElementById('item-category').addEventListener('change', function() {
            if (!document.getElementById('item-code').value) {
                document.getElementById('item-code').placeholder = 'Ex: ' + generateItemCode();
            }
        });
    </script>
</body>
</html>